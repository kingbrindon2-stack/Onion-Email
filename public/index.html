<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é£ä¹¦-æ»´æ»´å…¥èŒä¸­å¿ƒ</title>
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/element-plus"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
    .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header p { opacity: 0.9; margin-top: 4px; }
    .main-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    .filters-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 20px; }
    .filter-item { flex: 1; min-width: 180px; }
    .filter-item label { display: block; font-size: 13px; color: #606266; margin-bottom: 6px; font-weight: 500; }
    .table-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #ebeef5; }
    .toolbar-left { display: flex; align-items: center; gap: 16px; }
    .toolbar-right { display: flex; gap: 12px; }
    .stats { display: flex; gap: 16px; }
    .stat-item { background: #f4f4f5; padding: 6px 12px; border-radius: 6px; font-size: 13px; }
    .stat-item strong { color: #409eff; }
    .user-info { display: flex; flex-direction: column; gap: 2px; }
    .user-name { font-weight: 600; color: #303133; }
    .user-meta { font-size: 12px; color: #909399; }
    .editable-input { width: 100%; }
    .action-btn { padding: 4px 8px; }
    .log-console { background: #1e1e1e; border-radius: 12px; padding: 16px; margin-top: 20px; max-height: 240px; overflow-y: auto; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; }
    .log-console-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .log-console-header h3 { color: #4ade80; font-size: 14px; }
    .log-entry { padding: 3px 0; }
    .log-time { color: #6b7280; margin-right: 8px; }
    .log-level { padding: 1px 5px; border-radius: 3px; font-size: 10px; text-transform: uppercase; margin-right: 8px; }
    .log-level.info { background: #3b82f6; color: white; }
    .log-level.success { background: #22c55e; color: white; }
    .log-level.warn { background: #f59e0b; color: white; }
    .log-level.error { background: #ef4444; color: white; }
    .log-message { color: #e5e7eb; }
    .el-table .cell { padding: 8px 12px; }
    .tab-desc { font-size: 13px; color: #909399; margin-bottom: 16px; }
    .row-done { opacity: 0.5; }
    .row-done td { text-decoration: line-through; }
    .status-tag { font-size: 11px; }
  </style>
</head>
<body>
  <div id="app">
    <div class="app-container">
      <!-- Header -->
      <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h1>ğŸš€ é£ä¹¦-æ»´æ»´å…¥èŒä¸­å¿ƒ</h1>
            <p>è‡ªåŠ¨åŒ–å·¥ä½œé‚®ä»¶å’Œä¼ä¸šæ»´æ»´è´¦å·é…ç½®</p>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <el-tag :type="botEnabled ? 'success' : 'info'" size="large" effect="dark">
              {{ botEnabled ? 'ğŸ¤– æœºå™¨äººå·²å¯ç”¨' : 'ğŸ¤– æœºå™¨äººæœªé…ç½®' }}
            </el-tag>
            <el-button v-if="botEnabled" size="small" type="warning" plain 
              style="color: white; border-color: rgba(255,255,255,0.5);"
              @click="triggerBotCheck" :loading="botChecking">
              ğŸ“¢ æ‰‹åŠ¨æ¨é€é€šçŸ¥
            </el-button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-card">
        <el-tabs v-model="activeTab" @tab-change="handleTabChange">
          <!-- Tab 1: å¼€é€šé‚®ç®± -->
          <el-tab-pane label="ğŸ“§ å¼€é€šé‚®ç®±" name="email">
            <p class="tab-desc">ä¸ºå¾…å…¥èŒå‘˜å·¥ï¼ˆpreboardingï¼‰é…ç½®å·¥ä½œé‚®ç®±ã€‚å»ºè®®é‚®ç®±ç”±æ‹¼éŸ³è‡ªåŠ¨ç”Ÿæˆï¼Œå¼€é€šæ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥é‡å¤å¹¶å¤„ç†ã€‚</p>
            
            <!-- Filters -->
            <div class="filters-row">
              <div class="filter-item">
                <label>åŸå¸‚</label>
                <el-select v-model="emailFilters.city" placeholder="å…¨éƒ¨åŸå¸‚" clearable style="width: 100%">
                  <el-option v-for="city in emailCities" :key="city" :label="city" :value="city" />
                </el-select>
              </div>
              <div class="filter-item">
                <label>å…¥èŒæ—¥æœŸ</label>
                <el-date-picker v-model="emailFilters.date" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" 
                  value-format="YYYY-MM-DD" style="width: 100%" clearable />
              </div>
              <div class="filter-item">
                <label>äººå‘˜ç±»å‹</label>
                <el-select v-model="emailFilters.employeeType" placeholder="å…¨éƒ¨ç±»å‹" clearable style="width: 100%">
                  <el-option label="æ­£å¼" value="æ­£å¼" />
                  <el-option label="å®ä¹ " value="å®ä¹ " />
                  <el-option label="åŠ³åŠ¡" value="åŠ³åŠ¡" />
                  <el-option label="å¤–åŒ…" value="å¤–åŒ…" />
                </el-select>
              </div>
              <div class="filter-item" style="flex: 0;">
                <label>&nbsp;</label>
                <el-button type="primary" @click="fetchEmailHires" :loading="emailLoading">
                  åˆ·æ–°
                </el-button>
              </div>
            </div>

            <!-- Toolbar -->
            <div class="table-toolbar">
              <div class="toolbar-left">
                <el-checkbox v-model="emailSelectAll" @change="handleEmailSelectAll">å…¨é€‰</el-checkbox>
                <div class="stats">
                  <span class="stat-item">æ€»è®¡: <strong>{{ filteredEmailHires.length }}</strong></span>
                  <span class="stat-item">å·²é€‰: <strong>{{ selectedEmailUsers.length }}</strong></span>
                </div>
              </div>
              <div class="toolbar-right">
                <el-button type="success" @click="batchProvisionEmail" 
                  :disabled="selectedEmailUsers.length === 0" :loading="emailProvisioning">
                  ä¸€é”®å¼€é€šé‚®ç®± ({{ selectedEmailUsers.length }})
                </el-button>
              </div>
            </div>

            <!-- Table -->
            <el-table :data="filteredEmailHires" v-loading="emailLoading" stripe row-key="id" style="width: 100%"
              :row-class-name="({row}) => row.provisionStatus === 'success' ? 'row-done' : ''">
              <el-table-column width="50">
                <template #default="{ row }">
                  <el-checkbox v-model="row.selected" :disabled="row.provisionStatus === 'success'" />
                </template>
              </el-table-column>
              
              <el-table-column label="å‘˜å·¥ä¿¡æ¯" min-width="200">
                <template #default="{ row }">
                  <div class="user-info">
                    <span class="user-name">
                      {{ row.name }}
                      <el-tag v-if="row.isIntern" type="info" size="small" style="margin-left: 4px;">å®ä¹ </el-tag>
                      <el-tag v-else-if="row.employeeType && row.employeeType !== 'æ­£å¼'" type="warning" size="small" style="margin-left: 4px;">{{ row.employeeType }}</el-tag>
                    </span>
                    <span class="user-meta">{{ row.city }} Â· {{ row.onboardingDate }}</span>
                  </div>
                </template>
              </el-table-column>

              <el-table-column label="ç”µè¯" width="140">
                <template #default="{ row }">
                  <span>{{ row.phone || '-' }}</span>
                </template>
              </el-table-column>

              <el-table-column label="å»ºè®®é‚®ç®±" min-width="260">
                <template #default="{ row }">
                  <el-input v-model="row.suggested_email" size="small" 
                    :disabled="row.provisionStatus === 'success'" />
                  <div v-if="row.provisionStatus === 'success'" style="font-size: 11px; color: #67c23a; margin-top: 2px;">
                    âœ… å·²å¼€é€š: {{ row.provisionedEmail }}
                  </div>
                  <div v-if="row.provisionStatus === 'error'" style="font-size: 11px; color: #f56c6c; margin-top: 2px;">
                    âŒ {{ row.provisionError }}
                  </div>
                </template>
              </el-table-column>

              <el-table-column label="æ»´æ»´" width="110">
                <template #default="{ row }">
                  <el-tag v-if="row.isIntern" type="info" size="small">å®ä¹ -ä¸å¼€é€š</el-tag>
                  <el-tag v-else type="warning" size="small">å…¥èŒåå¼€é€š</el-tag>
                </template>
              </el-table-column>

              <el-table-column label="æ“ä½œ" width="100" fixed="right">
                <template #default="{ row }">
                  <el-button v-if="row.provisionStatus !== 'success'" type="primary" size="small" 
                    @click="provisionSingleEmail(row)" :loading="row.provisioning">
                    å¼€é€š
                  </el-button>
                  <el-tag v-else type="success" size="small" class="status-tag">å·²å¼€é€š</el-tag>
                </template>
              </el-table-column>
            </el-table>
          </el-tab-pane>

          <!-- Tab 2: å¼€é€šæ»´æ»´ -->
          <el-tab-pane label="ğŸš— å¼€é€šæ»´æ»´" name="didi">
            <p class="tab-desc">ä¸ºå·²å…¥èŒå‘˜å·¥ï¼ˆcompletedï¼‰å¼€é€šä¼ä¸šæ»´æ»´è´¦å·ã€‚å®ä¹ ç”Ÿé»˜è®¤ä¸å¼€é€šã€‚</p>
            
            <!-- Filters -->
            <div class="filters-row">
              <div class="filter-item">
                <label>åŸå¸‚</label>
                <el-select v-model="didiFilters.city" placeholder="å…¨éƒ¨åŸå¸‚" clearable style="width: 100%">
                  <el-option v-for="city in didiCities" :key="city" :label="city" :value="city" />
                </el-select>
              </div>
              <div class="filter-item">
                <label>å…¥èŒæ—¥æœŸ</label>
                <el-date-picker v-model="didiFilters.date" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" 
                  value-format="YYYY-MM-DD" style="width: 100%" clearable />
              </div>
              <div class="filter-item" style="flex: 0;">
                <label>&nbsp;</label>
                <el-button type="primary" @click="fetchDidiHires" :loading="didiLoading">
                  åˆ·æ–°
                </el-button>
              </div>
            </div>

            <!-- Toolbar -->
            <div class="table-toolbar">
              <div class="toolbar-left">
                <el-checkbox v-model="didiSelectAll" @change="handleDidiSelectAll">å…¨é€‰</el-checkbox>
                <div class="stats">
                  <span class="stat-item">æ€»è®¡: <strong>{{ filteredDidiHires.length }}</strong></span>
                  <span class="stat-item">å·²é€‰: <strong>{{ selectedDidiUsers.length }}</strong></span>
                  <span v-if="didiInternCount > 0" class="stat-item" style="color: #909399;">
                    å·²è¿‡æ»¤å®ä¹ ç”Ÿ: <strong>{{ didiInternCount }}</strong>
                  </span>
                </div>
              </div>
              <div class="toolbar-right">
                <el-button type="success" @click="batchProvisionDidi" 
                  :disabled="selectedDidiUsers.length === 0" :loading="didiProvisioning">
                  ä¸€é”®å¼€é€šæ»´æ»´ ({{ selectedDidiUsers.length }})
                </el-button>
              </div>
            </div>

            <!-- Table -->
            <el-table :data="filteredDidiHires" v-loading="didiLoading" stripe row-key="id" style="width: 100%"
              :row-class-name="({row}) => row.provisionStatus === 'success' ? 'row-done' : ''">
              <el-table-column width="50">
                <template #default="{ row }">
                  <el-checkbox v-model="row.selected" :disabled="row.provisionStatus === 'success'" />
                </template>
              </el-table-column>
              
              <el-table-column label="å‘˜å·¥ä¿¡æ¯" min-width="200">
                <template #default="{ row }">
                  <div class="user-info">
                    <span class="user-name">
                      {{ row.name }}
                      <el-tag v-if="row.employeeType && row.employeeType !== 'æ­£å¼'" type="warning" size="small" style="margin-left: 4px;">{{ row.employeeType }}</el-tag>
                    </span>
                    <span class="user-meta">{{ row.city }} Â· {{ row.onboardingDate }}</span>
                  </div>
                </template>
              </el-table-column>

              <el-table-column label="ç”µè¯" width="140">
                <template #default="{ row }">
                  <el-input v-model="row.phone" size="small" :disabled="row.provisionStatus === 'success'" />
                </template>
              </el-table-column>

              <el-table-column label="æ»´æ»´è§„åˆ™" min-width="200">
                <template #default="{ row }">
                  <el-select v-model="row.suggested_didi_rule_id" size="small" style="width: 100%" 
                    placeholder="é€‰æ‹©è§„åˆ™" filterable :disabled="row.provisionStatus === 'success'">
                    <el-option v-for="rule in didiRules" :key="rule.id" 
                      :label="rule.name" :value="rule.id" />
                  </el-select>
                  <div v-if="row.provisionStatus === 'success'" style="font-size: 11px; color: #67c23a; margin-top: 2px;">
                    âœ… å·²å¼€é€š
                  </div>
                  <div v-if="row.provisionStatus === 'error'" style="font-size: 11px; color: #f56c6c; margin-top: 2px;">
                    âŒ {{ row.provisionError }}
                  </div>
                </template>
              </el-table-column>

              <el-table-column label="æ“ä½œ" width="100" fixed="right">
                <template #default="{ row }">
                  <el-button v-if="row.provisionStatus !== 'success'" type="primary" size="small" 
                    @click="provisionSingleDidi(row)" :loading="row.provisioning">
                    å¼€é€š
                  </el-button>
                  <el-tag v-else type="success" size="small" class="status-tag">å·²å¼€é€š</el-tag>
                </template>
              </el-table-column>
            </el-table>
          </el-tab-pane>
        </el-tabs>
      </div>

      <!-- Log Console -->
      <div class="log-console" ref="logConsole">
        <div class="log-console-header">
          <h3>ğŸ“Ÿ å®æ—¶æ—¥å¿—</h3>
          <el-button size="small" text @click="clearLogs" style="color: #6b7280;">æ¸…ç©º</el-button>
        </div>
        <div v-for="(log, index) in logs" :key="index" class="log-entry">
          <span class="log-time">{{ formatTime(log.timestamp) }}</span>
          <span :class="['log-level', log.level]">{{ log.level }}</span>
          <span class="log-message">{{ log.message }}</span>
        </div>
        <div v-if="logs.length === 0" style="color: #6b7280; text-align: center; padding: 40px;">
          ç­‰å¾…æ—¥å¿—...
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;

    createApp({
      setup() {
        const activeTab = ref('email');
        const logs = ref([]);
        const logConsole = ref(null);
        let eventSource = null;

        // Email Tab State
        const emailLoading = ref(false);
        const emailProvisioning = ref(false);
        const emailHires = ref([]);
        const emailFilters = ref({ city: '', date: '', employeeType: '' });
        const emailSelectAll = ref(false);

        // Bot State
        const botEnabled = ref(false);
        const botChecking = ref(false);

        // Didi Tab State
        const didiLoading = ref(false);
        const didiProvisioning = ref(false);
        const didiHires = ref([]);
        const didiFilters = ref({ city: '', date: '' });
        const didiSelectAll = ref(false);
        const didiRules = ref([]);

        // Computed
        const emailCities = computed(() => {
          const citySet = new Set(emailHires.value.map(h => h.city).filter(Boolean));
          return Array.from(citySet).sort();
        });

        const filteredEmailHires = computed(() => {
          return emailHires.value.filter(h => {
            if (emailFilters.value.city && h.city !== emailFilters.value.city) return false;
            if (emailFilters.value.date && h.onboardingDate !== emailFilters.value.date) return false;
            if (emailFilters.value.employeeType && h.employeeType !== emailFilters.value.employeeType) return false;
            return true;
          });
        });

        const selectedEmailUsers = computed(() => {
          return filteredEmailHires.value.filter(h => h.selected && h.provisionStatus !== 'success');
        });

        const didiCities = computed(() => {
          const citySet = new Set(didiHires.value.map(h => h.city).filter(Boolean));
          return Array.from(citySet).sort();
        });

        // ç»Ÿè®¡è¢«è¿‡æ»¤æ‰çš„å®ä¹ ç”Ÿæ•°é‡
        const didiInternCount = computed(() => {
          return didiHires.value.filter(h => h.isIntern).length;
        });

        const filteredDidiHires = computed(() => {
          return didiHires.value.filter(h => {
            // è¿‡æ»¤æ‰å®ä¹ ç”Ÿ
            if (h.isIntern) return false;
            if (didiFilters.value.city && h.city !== didiFilters.value.city) return false;
            if (didiFilters.value.date && h.onboardingDate !== didiFilters.value.date) return false;
            return true;
          });
        });

        const selectedDidiUsers = computed(() => {
          return filteredDidiHires.value.filter(h => h.selected && h.provisionStatus !== 'success');
        });

        // Auto scroll log console
        const scrollLogToBottom = () => {
          nextTick(() => {
            if (logConsole.value) {
              logConsole.value.scrollTop = logConsole.value.scrollHeight;
            }
          });
        };

        // Methods
        const fetchEmailHires = async () => {
          emailLoading.value = true;
          try {
            const res = await fetch('/api/hires?status=preboarding');
            const data = await res.json();
            if (data.success) {
              emailHires.value = data.data.map(h => ({ 
                ...h, 
                selected: false, 
                provisioning: false,
                provisionStatus: null,    // null | 'success' | 'error'
                provisionedEmail: null,
                provisionError: null
              }));
            } else {
              ElMessage.error(data.error || 'è·å–æ•°æ®å¤±è´¥');
            }
          } catch (err) {
            ElMessage.error('ç½‘ç»œé”™è¯¯: ' + err.message);
          } finally {
            emailLoading.value = false;
          }
        };

        const fetchDidiHires = async () => {
          didiLoading.value = true;
          try {
            const res = await fetch('/api/hires?status=completed');
            const data = await res.json();
            if (data.success) {
              didiHires.value = data.data.map(h => ({ 
                ...h, 
                selected: false, 
                provisioning: false,
                provisionStatus: null,
                provisionError: null
              }));
            } else {
              ElMessage.error(data.error || 'è·å–æ•°æ®å¤±è´¥');
            }
          } catch (err) {
            ElMessage.error('ç½‘ç»œé”™è¯¯: ' + err.message);
          } finally {
            didiLoading.value = false;
          }
        };

        const fetchDidiRules = async () => {
          try {
            const res = await fetch('/api/didi/rules');
            const data = await res.json();
            if (data.success) {
              didiRules.value = data.data;
            }
          } catch (err) {
            console.error('Failed to fetch Didi rules:', err);
          }
        };

        const handleEmailSelectAll = (val) => {
          filteredEmailHires.value.forEach(h => {
            if (h.provisionStatus !== 'success') {
              h.selected = val;
            }
          });
        };

        const handleDidiSelectAll = (val) => {
          filteredDidiHires.value.forEach(h => {
            if (h.provisionStatus !== 'success') {
              h.selected = val;
            }
          });
        };

        const provisionSingleEmail = async (row) => {
          row.provisioning = true;
          row.provisionStatus = null;
          row.provisionError = null;
          try {
            const res = await fetch('/api/provision/email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: row.id, name: row.name, email: row.suggested_email })
            });
            const data = await res.json();
            if (data.success) {
              row.provisionStatus = 'success';
              row.provisionedEmail = data.email;
              row.selected = false;
              ElMessage.success(`${row.name} é‚®ç®±å¼€é€šæˆåŠŸ: ${data.email}`);
            } else {
              row.provisionStatus = 'error';
              row.provisionError = data.error || 'å¼€é€šå¤±è´¥';
              ElMessage.error(`${row.name}: ${data.error || 'å¼€é€šå¤±è´¥'}`);
            }
          } catch (err) {
            row.provisionStatus = 'error';
            row.provisionError = err.message;
            ElMessage.error('ç½‘ç»œé”™è¯¯: ' + err.message);
          } finally {
            row.provisioning = false;
          }
        };

        const batchProvisionEmail = async () => {
          const users = selectedEmailUsers.value;
          if (users.length === 0) return;

          try {
            await ElMessageBox.confirm(
              `ç¡®å®šä¸º ${users.length} åå‘˜å·¥å¼€é€šé‚®ç®±ï¼Ÿå¼€é€šæ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥é‡å¤å¹¶å¤„ç†ã€‚`, 
              'ç¡®è®¤æ“ä½œ', {
                confirmButtonText: 'ç¡®å®š',
                cancelButtonText: 'å–æ¶ˆ',
                type: 'warning'
              }
            );
          } catch { return; }

          emailProvisioning.value = true;
          try {
            const res = await fetch('/api/provision/email/batch', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                users: users.map(u => ({ id: u.id, name: u.name, email: u.suggested_email }))
              })
            });
            const data = await res.json();
            if (data.success && data.data) {
              // æ›´æ–°æ¯ä¸€è¡Œçš„çŠ¶æ€
              data.data.forEach(result => {
                const row = emailHires.value.find(h => h.id === result.id);
                if (row) {
                  if (result.success) {
                    row.provisionStatus = 'success';
                    row.provisionedEmail = result.email;
                    row.selected = false;
                  } else {
                    row.provisionStatus = 'error';
                    row.provisionError = result.error;
                  }
                }
              });
              const s = data.summary;
              ElMessage.success(`å®Œæˆ: æˆåŠŸ ${s.successful}, å¤±è´¥ ${s.failed}`);
            } else {
              ElMessage.error(data.error || 'æ‰¹é‡å¼€é€šå¤±è´¥');
            }
          } catch (err) {
            ElMessage.error('ç½‘ç»œé”™è¯¯: ' + err.message);
          } finally {
            emailProvisioning.value = false;
          }
        };

        const provisionSingleDidi = async (row) => {
          if (!row.suggested_didi_rule_id) {
            ElMessage.warning('è¯·å…ˆé€‰æ‹©æ»´æ»´è§„åˆ™');
            return;
          }
          if (!row.phone) {
            ElMessage.warning('è¯¥å‘˜å·¥æ²¡æœ‰ç”µè¯å·ç ');
            return;
          }
          row.provisioning = true;
          row.provisionStatus = null;
          row.provisionError = null;
          try {
            const res = await fetch('/api/provision/didi', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: row.name,
                phone: row.phone,
                didi_rule_id: row.suggested_didi_rule_id,
                employeeTypeId: row.employeeTypeId
              })
            });
            const data = await res.json();
            if (data.success) {
              row.provisionStatus = 'success';
              row.selected = false;
              ElMessage.success(`${row.name} æ»´æ»´è´¦å·å¼€é€šæˆåŠŸ`);
            } else {
              row.provisionStatus = 'error';
              row.provisionError = data.error || 'å¼€é€šå¤±è´¥';
              ElMessage.error(`${row.name}: ${data.error || 'å¼€é€šå¤±è´¥'}`);
            }
          } catch (err) {
            row.provisionStatus = 'error';
            row.provisionError = err.message;
            ElMessage.error('ç½‘ç»œé”™è¯¯: ' + err.message);
          } finally {
            row.provisioning = false;
          }
        };

        const batchProvisionDidi = async () => {
          const users = selectedDidiUsers.value;
          if (users.length === 0) return;

          const noRule = users.filter(u => !u.suggested_didi_rule_id);
          if (noRule.length > 0) {
            ElMessage.warning(`${noRule.length} åå‘˜å·¥æœªé€‰æ‹©æ»´æ»´è§„åˆ™`);
            return;
          }

          const noPhone = users.filter(u => !u.phone);
          if (noPhone.length > 0) {
            ElMessage.warning(`${noPhone.length} åå‘˜å·¥æ²¡æœ‰ç”µè¯å·ç `);
            return;
          }

          try {
            await ElMessageBox.confirm(`ç¡®å®šä¸º ${users.length} åå‘˜å·¥å¼€é€šæ»´æ»´ï¼Ÿ`, 'ç¡®è®¤æ“ä½œ', {
              confirmButtonText: 'ç¡®å®š',
              cancelButtonText: 'å–æ¶ˆ',
              type: 'warning'
            });
          } catch { return; }

          didiProvisioning.value = true;
          try {
            const res = await fetch('/api/provision/didi/batch', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                users: users.map(u => ({
                  name: u.name,
                  phone: u.phone,
                  didi_rule_id: u.suggested_didi_rule_id
                }))
              })
            });
            const data = await res.json();
            if (data.success && data.data) {
              // æ›´æ–°æ¯ä¸€è¡Œçš„çŠ¶æ€
              data.data.forEach(result => {
                const row = didiHires.value.find(h => h.name === result.name);
                if (row) {
                  if (result.success) {
                    row.provisionStatus = 'success';
                    row.selected = false;
                  } else {
                    row.provisionStatus = 'error';
                    row.provisionError = result.error;
                  }
                }
              });
              const s = data.summary;
              ElMessage.success(`å®Œæˆ: æˆåŠŸ ${s.successful}, å¤±è´¥ ${s.failed}`);
            } else {
              ElMessage.error(data.error || 'æ‰¹é‡å¼€é€šå¤±è´¥');
            }
          } catch (err) {
            ElMessage.error('ç½‘ç»œé”™è¯¯: ' + err.message);
          } finally {
            didiProvisioning.value = false;
          }
        };

        const fetchBotStatus = async () => {
          try {
            const res = await fetch('/api/health');
            const data = await res.json();
            botEnabled.value = data.bot_enabled || false;
          } catch {}
        };

        const triggerBotCheck = async () => {
          botChecking.value = true;
          try {
            const res = await fetch('/api/bot/check', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
              ElMessage.success('å·²æ¨é€é€šçŸ¥åˆ°é£ä¹¦ç¾¤');
            } else {
              ElMessage.error(data.error || 'æ¨é€å¤±è´¥');
            }
          } catch (err) {
            ElMessage.error('ç½‘ç»œé”™è¯¯: ' + err.message);
          } finally {
            botChecking.value = false;
          }
        };

        const handleTabChange = (tab) => {
          if (tab === 'email' && emailHires.value.length === 0) {
            fetchEmailHires();
          } else if (tab === 'didi' && didiHires.value.length === 0) {
            fetchDidiHires();
            fetchDidiRules();
          }
        };

        const connectSSE = () => {
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
          eventSource = new EventSource('/api/logs/stream');
          eventSource.onmessage = (event) => {
            try {
              const log = JSON.parse(event.data);
              logs.value.push(log);
              if (logs.value.length > 200) logs.value.shift();
              scrollLogToBottom();
            } catch {}
          };
          eventSource.onerror = () => {
            if (eventSource) {
              eventSource.close();
              eventSource = null;
            }
            setTimeout(connectSSE, 3000);
          };
        };

        const formatTime = (timestamp) => {
          const d = new Date(timestamp);
          return d.toLocaleTimeString('zh-CN', { hour12: false });
        };

        const clearLogs = () => {
          logs.value = [];
        };

        // Watch for select all sync
        watch(selectedEmailUsers, (val) => {
          const available = filteredEmailHires.value.filter(h => h.provisionStatus !== 'success');
          emailSelectAll.value = val.length === available.length && val.length > 0;
        });

        watch(selectedDidiUsers, (val) => {
          const available = filteredDidiHires.value.filter(h => h.provisionStatus !== 'success');
          didiSelectAll.value = val.length === available.length && val.length > 0;
        });

        onMounted(() => {
          fetchEmailHires();
          fetchBotStatus();
          connectSSE();
        });

        onUnmounted(() => {
          if (eventSource) eventSource.close();
        });

        return {
          activeTab, logs, logConsole,
          botEnabled, botChecking,
          emailLoading, emailProvisioning, emailHires, emailFilters, emailSelectAll,
          didiLoading, didiProvisioning, didiHires, didiFilters, didiSelectAll, didiRules,
          emailCities, filteredEmailHires, selectedEmailUsers,
          didiCities, didiInternCount, filteredDidiHires, selectedDidiUsers,
          fetchEmailHires, fetchDidiHires, handleTabChange,
          handleEmailSelectAll, handleDidiSelectAll,
          provisionSingleEmail, batchProvisionEmail,
          provisionSingleDidi, batchProvisionDidi,
          triggerBotCheck, formatTime, clearLogs
        };
      }
    }).use(ElementPlus).mount('#app');
  </script>
</body>
</html>
